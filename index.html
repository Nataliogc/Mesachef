<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gestor de Eventos ‚Äì MesaChef Enterprise v9.0</title>

    <link rel="icon" type="image/png" href="mesa-chef-192.png">
    <link rel="apple-touch-icon" href="mesa-chef-512.png">
    <meta name="theme-color" content="#263238">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- FIREBASE COMPAT -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- ESTILOS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #263238; --accent: #546e7a; --bg-body: #f0f2f5; --surface: #ffffff; --border: #dfe3e8; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background: var(--bg-body); color: #1a1a1a; font-size: 13px; }

        /* LANDING */
        #landingPage { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%); padding: 20px; }
        .landing-container { background: var(--surface); border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); padding: 40px; max-width: 900px; width: 100%; text-align: center; }
        .app-logo-big { width: 120px; height: 120px; object-fit: cover; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 10px; }
        .hotel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .h-card { border: 1px solid var(--border); border-radius: 20px; padding: 24px; cursor: pointer; transition: all 0.2s ease; background: #fff; display: flex; flex-direction: column; align-items: center; }
        .h-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.06); border-color: #10b981; }
        .h-card img { max-height: 50px; margin-bottom: 15px; object-fit: contain; }
        .h-tag { background: #f3f4f6; color: #4b5563; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; }

        /* HEADER */
        #appContainer { display: none; min-height: 100vh; flex-direction: column; }
        .app-header { background: #fff; padding: 10px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap:15px; }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .btn-back { width: 34px; height: 34px; border-radius: 50%; border: 1px solid #cfd8dc; background: #f5f5f5; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; border: none; }
        .header-title { font-size: 18px; font-weight: 700; color: var(--primary); margin: 0; }
        #headerLogo { max-height: 36px; object-fit: contain; }
        .connection-badge { display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; border: 1px solid transparent; white-space: nowrap; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-online { background: #e8f5e9; color: #1b5e20; border-color: #a5d6a7; } .status-online .status-dot { background: #2e7d32; }
        .status-offline { background: #ffebee; color: #c62828; border-color: #ef9a9a; } .status-offline .status-dot { background: #c62828; }
        .status-connecting { background: #fff7cc; color: #b45309; border-color: #facc15; } .status-connecting .status-dot { background: #f59e0b; }

        .module-tabs { display: flex; gap: 6px; background: #f5f5f5; padding: 4px; border-radius: 999px; }
        .tab-btn { border: none; background: transparent; padding: 6px 14px; border-radius: 999px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; color: #37474f; }
        .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }

        /* VISTAS */
        .controls-bar { padding: 15px 24px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
        .left-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .left-controls input, .left-controls select { margin: 0; width: auto; }
        .btn-nav { width: 30px; height: 30px; border: 1px solid #cbd5e1; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #475569; }
        .btn-nav:hover { background: #f1f5f9; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; display:flex; align-items:center; gap:5px; }

        /* SEARCH & IA */
        .search-wrapper { position: relative; display: flex; align-items: center; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; padding: 2px 4px; width: 300px; }
        .search-wrapper input { border: none; outline: none; padding: 6px 8px; font-size: 13px; width: 100%; border-radius: 6px; }
        .btn-search-ai { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 6px; padding: 4px 8px; font-size: 11px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap; transition: 0.2s; }
        .btn-search-ai:hover { box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4); transform: translateY(-1px); }
        .search-loading { position: absolute; right: 80px; font-size: 12px; display: none; }

        /* TABLE GRID */
        .table-wrapper { margin: 0 20px 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: auto; flex: 1; }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; min-width: 1200px; }
        th { background: #f8fafc; padding: 12px; text-align: left; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 600; }
        td { border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        .salon-name-cell { background-color: #e2e8f0; color: #1e293b; font-weight: 800; text-align: center; vertical-align: middle; border-right: 1px solid #cbd5e1; width: 140px; padding: 10px; position:sticky; left:0; z-index:5; }

        /* --- RESTAURANTE (C√ÅPSULAS) --- */
        .cell-rest { padding: 4px; display: flex; flex-direction: column; gap: 4px; height: 100%; min-height: 180px; }
        .rest-zone { flex: 1; min-height: 80px; border: 1px dashed; border-radius: 8px; padding: 4px; transition: background 0.2s; cursor: pointer; display: flex; flex-direction: column; gap: 3px; }
        .rest-zone:hover { background-color: #f8fafc; border-color: #94a3b8; }
        
        .lunch-zone { background-color: #fffbeb; border-color: #fcd34d; } .lunch-zone .slot-header { color: #b45309; }
        .dinner-zone { background-color: #faf5ff; border-color: #e9d5ff; } .dinner-zone .slot-header { color: #6b21a8; }
        
        .slot-header { font-size: 9px; font-weight: 800; text-transform: uppercase; display: flex; justify-content: space-between; margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px solid rgba(0,0,0,0.05); }

        .mesa-card { background: #fff; padding: 5px 8px; border-radius: 6px; font-size: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; border-left-width: 4px; transition: transform 0.1s; line-height: 1.3; margin-bottom: 2px; }
        .mesa-card:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-lunch { border-left-color: #f59e0b; } 
        .card-dinner { border-left-color: #9333ea; }
        .card-anulada { opacity: 0.6; text-decoration: line-through; border-left-color: #ef4444 !important; background: #fef2f2; }

        /* EVENTOS CARDS */
        .evt-full-day { background: #dbeafe; color: #1e40af; border-left: 4px solid #2563eb; border-radius: 4px; padding: 4px 6px; font-size: 11px; margin: 2px; cursor: pointer; min-height: 40px; }
        .evt-confirmado { background: #dcfce7 !important; color: #166534 !important; border-left-color: #22c55e !important; }
        .evt-pendiente { background: #ffedd5 !important; color: #9a3412 !important; border-left-color: #f97316 !important; opacity: 0.9; }

        /* LISTADOS */
        .budget-table th { background: #f1f5f9; padding: 12px; font-size: 11px; color: #64748b; border-bottom: 1px solid #e2e8f0; }
        .budget-row { border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.1s; }
        .budget-row:hover { background: #f8fafc; }
        .budget-row td { padding: 10px; font-size: 13px; }
        
        .badge { display: inline-flex; padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: 600; text-transform: capitalize; }
        .st-confirmado { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .st-pendiente { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        .st-anulado { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; text-decoration: line-through; }
        .st-caducado { background: #f3f4f6; color: #64748b; border: 1px solid #e2e8f0; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(2px); }
        .modal-content { background: #fff; width: 100%; max-width: 900px; max-height: 90vh; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: #fff; border-bottom: 1px solid #eee; }
        .modal-body { padding: 20px; overflow-y: auto; background: #fff; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px; background: #f8fafc; }

        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; display: flex; flex-direction: column; }
        label { font-size: 11px; text-transform: uppercase; color: #64748b; margin-bottom: 4px; font-weight: 600; }
        input, select, textarea { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; width: 100%; }
        input:focus, select:focus { outline:none; border-color: #8b5cf6; }
        
        .svc-table { width: 100%; border-collapse: separate; border-spacing: 0 4px; margin-top: 5px; }
        .svc-table th { background: #f8fafc; padding: 8px; font-size: 11px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        .svc-input { width: 100%; padding: 6px; border: 1px solid #e2e8f0; border-radius: 6px; text-align: center; height: 34px; font-size: 13px; }
        .btn-add-row { margin-top: 10px; background: #f0f9ff; border: 2px dashed #bae6fd; color: #0284c7; padding: 10px; border-radius: 8px; width: 100%; cursor:pointer; font-weight: 600; }

        .btn-primary { background: #0f172a; color: #fff; padding: 10px 20px; border-radius: 8px; border:none; cursor:pointer; font-weight: 600; }
        .btn-secondary { background: #fff; border: 1px solid #cbd5e1; color: #475569; padding: 10px 18px; border-radius: 8px; cursor:pointer; }
        .btn-anular { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; padding: 10px 18px; border-radius: 8px; cursor:pointer; }
        .btn-email { background: #8b5cf6; color: white; padding: 10px 18px; border-radius: 8px; font-weight: 600; border:none; cursor:pointer; display: flex; align-items: center; gap: 6px; }
        .btn-confirm { background: #10b981; color: white; padding: 10px 18px; border-radius: 8px; font-weight: 600; border:none; cursor:pointer; }

        /* IA MODAL */
        #aiResponseModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; justify-content: center; align-items: center; }
        .ai-box { background: white; padding: 20px; border-radius: 12px; width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 10px; }
        
        /* ESTILO ESPEC√çFICO RESTAURANTE EN MODAL */
        .rest-highlight { border: 1px solid #fcd34d; background: #fffbeb; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="landingPage">
    <div class="landing-container">
        <img src="mesa-chef-512.png" class="app-logo-big" alt="Logo" onerror="this.style.display='none'">
        <h1 style="margin:10px 0 5px; font-size:24px; color:#1f2937;">RESERVAS SALAS Y RESTAURANTE</h1>
        <p style="color:#666; margin-bottom:30px;">Gesti√≥n unificada para <strong>Sercotel Guadiana</strong> y <strong>Cumbria Spa&Hotel</strong>.</p>
        <div style="background:#d1fae5; color:#065f46; padding:4px 10px; border-radius:10px; display:inline-block; font-size:11px;">‚óè v9.0 Enterprise JS</div>
        <div class="hotel-grid">
            <div class="h-card" onclick="initApp('Guadiana')">
                <img src="Img/logo-guadiana.svg" alt="Sercotel Guadiana" onerror="this.style.display='none'">
                <h3>Sercotel Guadiana</h3>
            </div>
            <div class="h-card" onclick="initApp('Cumbria')">
                <img src="Img/logo-cumbria.svg" alt="Cumbria Spa&Hotel" onerror="this.style.display='none'">
                <h3>Cumbria Spa&Hotel</h3>
            </div>
        </div>
    </div>
</div>

<div id="appContainer">
    <header class="app-header">
        <div class="header-left">
            <button class="btn-back" onclick="location.reload()">‚¨Ö</button>
            <h2 id="tituloHotelActual" class="header-title">Hotel</h2>
            <img id="headerLogo" style="height:30px; margin-left:10px;" />
            <div class="connection-badge status-offline" id="statusBadge">
                <span class="status-dot"></span><span id="statusText">...</span>
            </div>
        </div>
        <div class="header-right">
            <div class="module-tabs">
                <button class="tab-btn active" onclick="setModulo('eventos')" id="btnModEventos">üìÖ Salones</button>
                <button class="tab-btn" onclick="setModulo('restaurante')" id="btnModRest">üç¥ Restaurante</button>
                <button class="tab-btn" onclick="setModulo('presupuestos')" id="btnModPpto">üìÑ Presupuestos</button>
                <button class="tab-btn" onclick="setModulo('grandes_eventos')" id="btnModGran">üéâ Grandes Eventos</button>
            </div>
            <a href="admin.html" class="btn-secondary" style="text-decoration:none; padding:6px 12px; font-size:12px;">‚öôÔ∏è Config</a>
        </div>
    </header>

    <div class="controls-bar">
        <div class="left-controls">
            <button class="btn-nav" onclick="cambiarSemana(-7)">‚ùÆ</button>
            <input type="date" id="fechaVista" onchange="render()" title="Fecha inicio vista" />
            <button class="btn-nav" onclick="cambiarSemana(7)">‚ùØ</button>
            <select id="filtroEstado" onchange="render()">
                <option value="todos">üëÅÔ∏è Ver Todo</option>
                <option value="activos" selected>Ver activos</option>
                <option value="pendiente">‚è≥ Pendientes</option>
                <option value="confirmado">‚úÖ Confirmados</option>
                <option value="caducado">‚õî Caducados</option>
                <option value="anulado">‚ùå Anulados</option>
            </select>
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="üîé Buscar..." oninput="render()">
                <button class="btn-search-ai" onclick="menuIA()">‚ú® Menu IA</button>
            </div>
        </div>
        <button class="btn-primary" id="btnNuevoPrincipal" onclick="nuevoGeneral()">+ Nuevo</button>
    </div>

    <div class="table-wrapper">
        <table id="mainTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
        <div id="presupuestosContainer" style="display: none">
            <table class="budget-table">
                <thead><tr style="background:#f8fafc"><th style="width:100px">Fecha</th><th style="width:120px">Ref</th><th>Cliente</th><th style="width:140px">Sal√≥n</th><th style="width:100px">Estado</th><th style="width:80px;text-align:right">Total</th></tr></thead>
                <tbody id="budgetBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL FICHA -->
<div class="modal-overlay" id="modalFicha">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle" style="font-size:18px; font-weight:700; color:#333;">Ficha</h3>
            <button onclick="document.getElementById('modalFicha').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;">√ó</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="dataId"><input type="hidden" id="dataType"><input type="hidden" id="refPresupuesto">
            
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:20px;">
                <div class="form-row">
                    <div class="form-group" id="grpFechaUnica"><label>Fecha</label><input type="date" id="inpFecha" /></div>
                    <div class="form-group" id="grpRangoFechas" style="display:none; gap:10px;">
                        <div style="flex:1"><label>Desde</label><input type="date" id="inpFechaDesde" /></div>
                        <div style="flex:1"><label>Hasta</label><input type="date" id="inpFechaHasta" /></div>
                    </div>
                    <!-- T√≠tulo cambia din√°micamente -->
                    <div class="form-group" style="flex:2"><label>Cliente / Evento</label><input type="text" id="inpNombre" oninput="actualizarTituloModal(this.value)" /></div>
                </div>
                <div class="form-row" id="rowContacto">
                    <div class="form-group"><label>Tel√©fono</label><input type="text" id="inpTel" /></div>
                    <div class="form-group" id="grpEmail" style="flex:2"><label>Email</label><input type="text" id="inpEmail" /></div>
                </div>
            </div>
            
            <!-- RESTAURANTE FIELDS (Estilo Destacado) -->
            <div id="blockRestaurante" style="display:none;" class="rest-highlight">
                <div class="form-row">
                    <div class="form-group"><label>Hora</label><input type="time" id="inpHora" /></div>
                    <div class="form-group"><label>Pax</label><input type="number" id="inpPaxRest" /></div>
                    <!-- NUEVO CAMPO: Precio p/p -->
                    <div class="form-group"><label>Precio P/P (‚Ç¨)</label><input type="number" id="inpPrecioRest" /></div>
                    <div class="form-group"><label>Zona</label><select id="inpZonaRest"><option>Restaurante</option><option>Cafeter√≠a</option></select></div>
                    <div class="form-group"><label>Turno</label><select id="inpTurno"><option value="manana">‚òÄÔ∏è Almuerzo</option><option value="tarde">üåô Cena</option></select></div>
                </div>
            </div>

            <!-- EVENTO FIELDS -->
            <div id="blockEventos">
                <div class="form-row">
                    <div class="form-group" style="flex:1.5"><label>Espacio</label><select id="inpSalon"></select></div>
                    <div class="form-group"><label>Estado</label><select id="inpEstadoEvento"><option value="pendiente">‚è≥ Pendiente</option><option value="confirmado">‚úÖ Confirmado</option></select></div>
                    <div class="form-group"><label>Jornada</label><select id="inpTurnoEvento"><option value="dia_completo">Jornada Comp.</option><option value="manana">1/2 D√≠a (Ma√±ana)</option><option value="tarde">1/2 D√≠a (Tarde)</option></select></div>
                    <div class="form-group"><label>Montaje</label><select id="inpMontaje"><option>Banquete</option><option>Escuela</option><option>Teatro</option><option>C√≥ctel</option><option>U</option></select></div>
                    <div class="form-group" style="width:80px;"><label>Pax A.</label><input type="number" id="inpPaxA" /></div>
                </div>
                
                <div style="margin-top:10px; border-top:1px solid #e2e8f0; padding-top:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <label style="color:var(--primary); font-weight:700;">DESGLOSE / SERVICIOS</label>
                        <button class="btn-ai-purple" onclick="generarMenuIA()">üü£ Men√∫ IA</button>
                    </div>
                    <table class="svc-table">
                        <thead><tr><th>Fecha</th><th>Concepto</th><th>Uds</th><th>Precio</th><th>Total</th><th></th></tr></thead>
                        <tbody id="bodyServicios"></tbody>
                    </table>
                    <button class="btn-add-row" onclick="addServiceRow()">+ A√±adir l√≠nea</button>
                    <div style="text-align:right; font-size:15px; font-weight:700; margin-top:10px;">TOTAL: <span id="totalAmount">0.00</span> ‚Ç¨</div>
                </div>
            </div>

            <!-- BLOQUE GRANDES EVENTOS -->
            <div id="blockGran" style="display:none; background:#fdf2f8; padding:10px; border-radius:8px; border:1px solid #fbcfe8;">
                <div class="form-row">
                    <div class="form-group"><label>Aforo</label><input type="number" id="inpAforo" oninput="calcGran()"></div>
                    <div class="form-group"><label>Precio Std</label><input type="number" id="inpPrcStd" onchange="aplicarStd()"></div>
                </div>
                <div style="font-weight:bold; margin-bottom:5px;">Pax: <span id="gPax">0</span> | Total: <span id="gTot">0</span>‚Ç¨ | Pendiente: <span id="gPend" style="color:red">0.00</span>‚Ç¨</div>
                <table class="svc-table">
                    <thead><tr><th>Mesa</th><th>Nombre</th><th>Pax</th><th>Precio</th><th>Pagado</th><th></th></tr></thead>
                    <tbody id="bodyPart"></tbody>
                </table>
                <button class="btn-add-row" style="color:#be185d;" onclick="addPart()">+ A√±adir Participante</button>
            </div>

            <div style="margin-top:15px;">
                <label>Notas</label>
                <textarea id="inpNotas" rows="2" style="width:100%"></textarea>
            </div>
            
            <div id="notasClienteBlock" style="margin-top:15px;">
                <label>Nota Cliente (PDF)</label>
                <textarea id="inpNotaCliente" rows="2" style="width:100%"></textarea>
            </div>
        </div>
        
        <!-- FOOTER CORREGIDO -->
        <div class="modal-footer">
            <button class="btn-email" id="btnEmail" onclick="redactarEmailIA()" style="display:none;">üìß Email</button>
            <button class="btn-secondary" id="btnPdf" onclick="imprimirPDF()" style="display:none; gap:5px;">üìÑ PDF</button>
            
            <!-- BOT√ìN ANULAR (ROJO) -->
            <button class="btn-anular" id="btnAnular" onclick="anularFicha()" style="display:none;">Anular</button>
            
            <button class="btn-secondary" id="btnRecuperar" onclick="recuperarFicha()" style="display:none;">üîÑ Recuperar</button>
            <button class="btn-confirm" id="btnConfirmarPpto" onclick="confirmarPresupuesto()" style="display:none;">‚úÖ Confirmar</button>
            
            <div style="flex:1"></div>
            
            <button class="btn-secondary" onclick="document.getElementById('modalFicha').style.display='none'">Cancelar</button>
            <button class="btn-primary" id="btnGuardarMain" onclick="guardarFicha()">GUARDAR</button>
        </div>
    </div>
</div>

<div id="aiResponseModal"><div class="ai-box"><h3>ü§ñ Respuesta IA</h3><textarea id="aiOutput" style="width:100%; height:200px; padding:10px; border:1px solid #ccc;"></textarea><div style="text-align:right; margin-top:10px;"><button class="btn-secondary" onclick="document.getElementById('aiResponseModal').style.display='none'">Cerrar</button> <button class="btn-primary" onclick="copiarAI()">Copiar</button></div></div></div>

<script>
    const apiKey = "AIzaSyDnJMniLswGjpysPHiH3n3L6EpJyCkbS4E"; 
    const firebaseConfig = { apiKey: "AIzaSyBAK0sGUYpV8KHy1KwIdNRLtHlq5LT3Vwg", authDomain: "gestionsalones-bba4b.firebaseapp.com", projectId: "gestionsalones-bba4b", storageBucket: "gestionsalones-bba4b.firebasestorage.app", messagingSenderId: "860164285474", appId: "1:860164285474:web:ff995e88093e5aa5eb167b" };
    firebase.initializeApp(firebaseConfig);

    const statusBadge = document.getElementById("statusBadge");
    const statusText  = document.getElementById("statusText");

    function setStatus(mode) {
        statusBadge.classList.remove("status-online", "status-offline", "status-connecting");
        if (mode === "connecting") {
            statusBadge.classList.add("status-connecting"); statusText.innerText = "Conectando...";
        } else if (mode === "online") {
            statusBadge.classList.add("status-online"); statusText.innerText = "Conectado";
        } else {
            statusBadge.classList.add("status-offline"); statusText.innerText = "Desconectado";
        }
    }

    setStatus("connecting");
    firebase.firestore().enableNetwork().then(() => setStatus("online")).catch(() => setStatus("offline"));
    window.addEventListener("offline", () => setStatus("offline"));
    window.addEventListener("online",  () => setStatus("connecting"));
    const db = firebase.firestore();

    setInterval(async () => {
        try { await db.collection("test_connection").limit(1).get(); setStatus("online"); } catch (e) { setStatus("offline"); }
    }, 8000);

    let currentHotel = null, currentModule = "eventos", dataCache = [], salonesConfig = {Guadiana:[], Cumbria:[], horarios:{}};
    let aiFilteredIds = null;

    // HELPER SEGURO PARA DISPLAY
    function safeShow(id, show) {
        const el = document.getElementById(id);
        if(el) el.style.display = show ? (el.tagName==='BUTTON'?'inline-flex':'block') : 'none';
    }

    function initApp(h) {
        currentHotel = h;
        document.getElementById("tituloHotelActual").innerText = h;
        const logo = document.getElementById("headerLogo");
        if(logo) logo.src = h==="Guadiana" ? "Img/logo-guadiana.svg" : "Img/logo-cumbria.svg";
        document.getElementById("landingPage").style.display = "none";
        document.getElementById("appContainer").style.display = "flex";
        document.getElementById("fechaVista").valueAsDate = new Date();
        
        db.collection("master_data").doc("CONFIG_SALONES").onSnapshot(doc => { 
            if(doc.exists) salonesConfig = doc.data(); 
            render(); 
        });
        cargarDatos();
        setModulo('restaurante');
    }

    /* ---------------------------------------------------------------
       1. CARGAR DATOS
       --------------------------------------------------------------- */
    function cargarDatos() {
        dataCache = [];

        db.collection("eventos").onSnapshot(snap => {
            dataCache = dataCache.filter(x => x.type !== "evento");
            snap.forEach(d => {
                dataCache.push({ id: d.id, ...d.data(), type: "evento" });
            });
            render();
        });

        db.collection("grandes_eventos").onSnapshot(snap => {
            dataCache = dataCache.filter(x => x.type !== "gran_evento");
            snap.forEach(d => {
                dataCache.push({ id: d.id, ...d.data(), type: "gran_evento" });
            });
            render();
        });

        db.collection("restaurante").onSnapshot(snap => {
            dataCache = dataCache.filter(x => x.type !== "restaurante");
            snap.forEach(d => {
                dataCache.push({ id: d.id, ...d.data(), type: "restaurante" });
            });
            render();
        });

        // FUERZA EL TIPO PRESUPUESTO EN CARGA PARA CORREGIR DATOS ANTIGUOS
        db.collection("presupuestos").onSnapshot(snap => {
            dataCache = dataCache.filter(x => x.type !== "presupuesto");
            snap.forEach(d => {
                dataCache.push({ id: d.id, ...d.data(), type: "presupuesto" });
            });
            render();
        });
    }

    function setModulo(m) {
        currentModule = m;
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        if(m==="eventos") document.getElementById("btnModEventos").classList.add("active");
        if(m==="restaurante") document.getElementById("btnModRest").classList.add("active");
        if(m==="presupuestos") document.getElementById("btnModPpto").classList.add("active");
        if(m==="grandes_eventos") document.getElementById("btnModGran").classList.add("active");

        const isList = (m==="presupuestos" || m==="grandes_eventos");
        document.getElementById("mainTable").style.display = isList ? "none" : "table";
        document.getElementById("presupuestosContainer").style.display = isList ? "block" : "none";
        
        document.querySelectorAll(".btn-nav").forEach(btn => btn.style.display = (m==="presupuestos"?"none":"flex"));
        const btn = document.getElementById("btnNuevoPrincipal");
        if(m==="eventos") btn.innerText = "+ Nuevo Evento";
        if(m==="restaurante") btn.innerText = "+ Nueva Mesa";
        if(m==="presupuestos") btn.innerText = "+ Nuevo Presupuesto";
        if(m==="grandes_eventos") btn.innerText = "+ Gran Evento";
        
        document.getElementById("searchInput").value = "";
        aiFilteredIds = null;
        render();
    }

    /* ---------------------------------------------------------------
       2. RENDER (L√ìGICA CORREGIDA PARA QUE NO DESAPAREZCAN DATOS)
       --------------------------------------------------------------- */
    function render() {
        if(currentModule === "presupuestos" || currentModule === "grandes_eventos") {
            const body = document.getElementById("budgetBody");
            const isGran = currentModule === "grandes_eventos";
            body.innerHTML = "";
            const typeFilter = isGran ? "gran_evento" : "presupuesto";
            const filtro = document.getElementById("filtroEstado").value;
            const searchText = document.getElementById("searchInput").value.toLowerCase();
            const hoyStr = new Date().toISOString().split("T")[0]; // Fecha de hoy

            const items = dataCache.filter(d => {
                if (d.type !== typeFilter) return false;
                if (d.hotel !== currentHotel) return false;

                // C√ÅLCULO ESTADO REAL (CADUCIDAD)
                let estadoReal = d.estado || "Pendiente";
                // Normalizar 'Anulado' para que coincida con el filtro
                if(estadoReal === 'anulado' || estadoReal === 'Anulado') estadoReal = 'Anulado';

                let fechaRef = d.fechaInicio || d.fecha;

                if (estadoReal === "Pendiente" && fechaRef < hoyStr) {
                    estadoReal = "Caducado";
                }

                // BUSCADOR
                if (searchText) return JSON.stringify(d).toLowerCase().includes(searchText);

                // FILTROS MEJORADOS
                switch (filtro) {
                    case "todos":
                        return true; // MUESTRA TODO
                    case "activos":
                        // Activos = Pendientes actuales + Confirmados + Espera
                        return (estadoReal !== "Anulado" && estadoReal !== "Caducado");
                    case "pendiente":
                        // MUESTRA PENDIENTES Y TAMBI√âN LOS CADUCADOS (Para que los veas)
                        return (estadoReal === "Pendiente" || estadoReal === "Caducado");
                    case "confirmado":
                        return estadoReal === "Confirmado";
                    case "caducado":
                        return estadoReal === "Caducado";
                    case "anulado":
                        return estadoReal === "Anulado";
                }

                return true;
            });

            items.sort((a,b) => new Date(a.fechaInicio) - new Date(b.fechaInicio));

            if(items.length === 0) {
                 const tr = document.createElement("tr");
                 tr.innerHTML = `<td colspan="6" style="text-align:center; padding:20px; color:#666;">No se encontraron datos. Prueba con el filtro "üëÅÔ∏è Ver Todo"</td>`;
                 body.appendChild(tr);
            }

            items.forEach(d => {
                const tr = document.createElement("tr"); 
                tr.className = "budget-row";
                let badgeClass = 'st-pendiente';
                let estadoVisual = d.estado || "Pendiente";
                if(estadoVisual.toLowerCase() === 'anulado') estadoVisual = 'Anulado';
                
                if (estadoVisual === "Pendiente" && (d.fechaInicio || d.fecha) < hoyStr) {
                    estadoVisual = "Caducado";
                    badgeClass = "st-caducado";
                } else if (estadoVisual === "Confirmado" || estadoVisual === "confirmado") {
                    badgeClass = "st-confirmado";
                } else if (estadoVisual === "Anulado") {
                    badgeClass = "st-anulado";
                }

                const fechaFmt = formatearFechaListado(d.fechaInicio);
                const totalCalc = d.total ? parseFloat(d.total).toFixed(2) + " ‚Ç¨" : "-";

                tr.innerHTML = `
                    <td>${fechaFmt}</td>
                    <td>${d.numero || '-'}</td>
                    <td><b>${d.nombre}</b><br><small style="color:#6b7280;">${d.montaje || 'Montaje no indicado'} ¬∑ ${d.paxA || 0} pax</small></td>
                    <td>${d.salon || 'Sin Sal√≥n'}</td>
                    <td><span class="badge ${badgeClass}">${estadoVisual}</span></td>
                    <td style="text-align:right; font-weight:bold;">${totalCalc}</td>
                `;
                tr.onclick = () => abrirModalId(d.id);
                body.appendChild(tr);
            });
            return;
        }

        const thead = document.getElementById("tableHead");
        const tbody = document.getElementById("tableBody");
        thead.innerHTML = ""; tbody.innerHTML = "";
        
        const fBase = new Date(document.getElementById("fechaVista").value);
        let hRow = `<tr><th style="width:150px;left:0;z-index:10;background:#fff;border-right:1px solid #e2e8f0;">ESPACIO</th>`;
        
        for(let i=0; i<7; i++) {
            const d = new Date(fBase); d.setDate(d.getDate() + i);
            const diaSem = d.getDay(); 
            const esFinde = (diaSem === 5 || diaSem === 6 || diaSem === 0);
            const bg = esFinde ? 'background:#f1f5f9 !important;' : 'background:#fff;';
            hRow += `<th style="${bg}">${d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short', year: '2-digit' })}</th>`;
        }
        thead.innerHTML = hRow + "</tr>";

        let rows = [];
        if (currentModule === "restaurante") {
            rows = [{name: "Restaurante"}, {name: "Cafeter√≠a"}];
        } else {
            rows = (salonesConfig[currentHotel] || []).filter(s => s.active);
        }

        rows.forEach(s => {
            const tr = document.createElement("tr");
            let row = `<td class="salon-name-cell" style="position:sticky;left:0;z-index:5">${s.name}</td>`;
            
            for(let i=0; i<7; i++) {
                const d = new Date(fBase); d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split("T")[0];
                let cellContent = "";

                // --- RESTAURANTE GRID (C√ÅPSULAS SEPARADAS) ---
                if(currentModule === "restaurante") {
                    const dayRes = dataCache.filter(x => {
                        if(x.hotel!==currentHotel || x.type!=="restaurante" || x.zona!==s.name || x.fecha!==dateStr) return false;
                        
                        let st = x.estado || "Confirmado"; // Por defecto en restaurante
                        if(filtro === "activos" && st === "Anulado") return false;
                        if(filtro === "anulado" && st !== "Anulado") return false;
                        // Otros filtros...
                        
                        return true;
                    });
                    
                    const manana = dayRes.filter(x => x.turno === "manana");
                    const tarde = dayRes.filter(x => x.turno === "tarde");
                    const paxM = manana.reduce((acc,curr)=>acc+(parseInt(curr.pax)||0),0);
                    const paxT = tarde.reduce((acc,curr)=>acc+(parseInt(curr.pax)||0),0);

                    cellContent = `
                    <div class="cell-rest">
                        <div class="rest-zone lunch-zone" onclick="nuevo('${dateStr}', '${s.name}', 'manana')">
                            <div class="slot-header lunch-text"><span>ALMUERZO</span><span>${paxM} pax</span></div>
                            ${manana.map(r => `<div class="mesa-card card-lunch ${r.estado==='Espera'?'card-espera':''}" onclick="event.stopPropagation(); abrirModalId('${r.id}')"><b>${r.hora}</b> ${r.nombre} (${r.pax}p)</div>`).join('')}
                        </div>
                        <div class="rest-zone dinner-zone" onclick="nuevo('${dateStr}', '${s.name}', 'tarde')">
                             <div class="slot-header dinner-text"><span>CENA</span><span>${paxT} pax</span></div>
                             ${tarde.map(r => `<div class="mesa-card card-dinner ${r.estado==='Espera'?'card-espera':''}" onclick="event.stopPropagation(); abrirModalId('${r.id}')"><b>${r.hora}</b> ${r.nombre} (${r.pax}p)</div>`).join('')}
                        </div>
                    </div>`;
                } else {
                    // SALONES
                    const evts = dataCache.filter(x => {
                        if(x.hotel!==currentHotel || x.salon!==s.name || x.fechaInicio!==dateStr) return false;
                        if(filtro === "activos" && x.estado === 'Anulado') return false;
                        return true;
                    });
                    
                    cellContent = `<div style="min-height:80px; padding:4px; display:flex; flex-direction:column; gap:2px;" onclick="nuevo('${dateStr}', '${s.name}', '')">`;
                    evts.forEach(e => {
                        let cls = `evt-full-day ${e.estado==='Confirmado'?'evt-confirmado':'evt-pendiente'}`;
                        if(e.estado==='Anulado') cls = 'evt-full-day evt-anulado card-anulada';
                        cellContent += `<div class="${cls}" onclick="event.stopPropagation(); abrirModalId('${e.id}')"><b>${e.nombre}</b></div>`;
                    });
                    cellContent += `</div>`;
                }
                
                row += `<td style="vertical-align:top; border-bottom:1px solid #eee; border-right:1px solid #eee; padding:0;">${cellContent}</td>`;
            }
            tr.innerHTML = row;
            tbody.appendChild(tr);
        });
    }

    function nuevoGeneral() { nuevo(new Date().toISOString().split("T")[0], "", ""); }
    
    function nuevo(fecha, salon, turno) {
        document.getElementById("dataId").value = "";
        let type = (currentModule==="restaurante") ? "restaurante" : (currentModule==="presupuestos" ? "presupuesto" : "evento");
        document.getElementById("dataType").value = type;
        
        // T√çTULO INICIAL
        const titulo = type==="restaurante" ? "Nueva Reserva" : "Nuevo Evento";
        document.getElementById("modalTitle").innerText = titulo;
        
        // Reset inputs
        document.querySelectorAll("#modalFicha input").forEach(i=>i.value="");
        document.querySelectorAll("#modalFicha textarea").forEach(i=>i.value="");
        document.getElementById("inpFecha").value = fecha;
        
        const sel = document.getElementById("inpSalon"); sel.innerHTML = "";
        const allS = salonesConfig[currentHotel] || [];
        if(type==="presupuesto") sel.innerHTML = "<option value='Pendiente'>-- Pendiente --</option>";
        
        allS.forEach(s => {
            if(!s.active) return;
            let infoExtra = "";
            if(s.pax > 0) infoExtra += `Max: ${s.pax}`;
            if(s.size > 0) infoExtra += (infoExtra ? " | " : "") + `${s.size} m¬≤`;
            if(infoExtra) infoExtra = ` (${infoExtra})`;
            const esRest = s.name.includes("Restaurante") || s.name.includes("Cafeter√≠a");
            if(type==="restaurante" && esRest) sel.innerHTML += `<option value="${s.name}">${s.name}${infoExtra}</option>`;
            if(type!=="restaurante" && !esRest) sel.innerHTML += `<option value="${s.name}">${s.name}${infoExtra}</option>`;
        });
        if(salon) sel.value = salon;

        if(type === "restaurante") {
            const now = new Date();
            document.getElementById("inpHora").value = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            document.getElementById("inpZonaRest").value = salon || "Restaurante";
            document.getElementById("inpTurno").value = turno || "manana";
        } else {
            if(salon) sel.value = salon;
            if(type==="presupuesto") {
                document.getElementById("inpFechaDesde").value = fecha;
                document.getElementById("inpFechaHasta").value = fecha;
            }
            addServiceRow({ desc: "Alquiler de Sal√≥n", price: "" });
            setTimeout(actualizarLineaSalon, 200);
        }

        document.getElementById("blockRestaurante").style.display = (type==="restaurante") ? "block" : "none";
        document.getElementById("blockEventos").style.display = (type!=="restaurante" && type!=="gran_evento") ? "block" : "none";
        document.getElementById("blockGran").style.display = (type==="gran_evento") ? "block" : "none";
        document.getElementById("grpRangoFechas").style.display = (type==="presupuesto") ? "flex" : "none";
        document.getElementById("grpFechaUnica").style.display = (type==="presupuesto") ? "none" : "block";
        document.getElementById("grpEmail").style.display = (type==="restaurante") ? "none" : "block"; // HIDE EMAIL FOR RESTAURANT
        
        // OCULTAR BOTONES INNECESARIOS EN RESTAURANTE
        const isRest = type === "restaurante";
        document.getElementById("btnPdf").style.display = (type==="presupuesto") ? "inline-flex" : "none"; 
        document.getElementById("btnConfirmarPpto").style.display = (type==="presupuesto") ? "inline-flex" : "none";
        document.getElementById("btnEmail").style.display = (type==="presupuesto") ? "inline-flex" : "none";
        document.getElementById("notasClienteBlock").style.display = isRest ? "none" : "block";

        document.getElementById("bodyServicios").innerHTML = "";
        document.getElementById("totalAmount").innerText = "0.00";
        document.getElementById("btnAnular").style.display = "none"; 
        
        document.getElementById("modalFicha").style.display = "flex";
    }

    function addServiceRow(d={}) {
        const tr = document.createElement("tr");
        let defDate = document.getElementById("inpFecha").value;
        let showPrice = d.price ? d.price : "";
        tr.innerHTML = `<td><input type="date" class="svc-input s-date" value="${d.date||defDate}"></td><td><input class="svc-input s-desc" value="${d.desc||''}" style="text-align:left"></td><td><input type="number" class="svc-input s-uds" value="${d.uds||1}" oninput="calcTotal()"></td><td><input type="text" class="svc-input s-price" value="${showPrice}" placeholder="0.00 ‚Ç¨" onblur="formatPrice(this); calcTotal()" onfocus="this.select()"></td><td><input class="svc-input s-tot" readonly style="font-weight:bold;"></td><td style="color:red; cursor:pointer; text-align:center;" onclick="this.parentElement.remove(); calcTotal(); updatePresupuestoDates()">‚úï</td>`;
        document.getElementById("bodyServicios").appendChild(tr);
        if(d.price) calcTotal(); 
    }

    function actualizarLineaSalon() {
        const firstRow = document.querySelector("#bodyServicios tr");
        if (!firstRow) return;

        const salonEl = document.getElementById("inpSalon");
        const turnoEl = document.getElementById("inpTurnoEvento");
        if (!salonEl || !turnoEl) return;

        const salon = salonEl.value;
        const turno = turnoEl.value;

        const inputDesc  = firstRow.querySelector(".s-desc");
        const inputPrice = firstRow.querySelector(".s-price");
        if (!inputDesc || !inputPrice) return;

        if (!salon || salon === "Pendiente") {
            if (inputDesc.value.includes("Alquiler")) { inputDesc.value = "Alquiler de Sal√≥n"; }
            inputPrice.value = "";
            calcTotal();
            return;
        }

        let txtJornada = (turno === "dia_completo") ? "Jornada Comp." : (turno==="manana" ? "1/2 D√≠a (Ma√±ana)" : "1/2 D√≠a (Tarde)");
        inputDesc.value = `Alquiler Sal√≥n ${salon} - ${txtJornada}`;

        const configHotel = salonesConfig[currentHotel] || [];
        const datos = configHotel.find(s => (s.name || "").trim() === salon.trim());

        let precio = 0;
        if (datos) {
            const safeFloat = (v) => parseFloat(String(v).replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
            let pFull = safeFloat(datos.priceFull);
            let pHalf = safeFloat(datos.priceHalf);
            precio = (turno === "dia_completo") ? pFull : pHalf;
        }
        inputPrice.value = precio > 0 ? precio.toFixed(2) + " ‚Ç¨" : "";
        calcTotal();
    }

    function formatPrice(el) {
        let val = parseFloat(el.value.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
        if(val > 0) el.value = val.toFixed(2) + " ‚Ç¨";
        else el.value = "";
    }

    function calcTotal() {
        let total = 0;
        document.querySelectorAll("#bodyServicios tr").forEach(tr => {
            const uds = parseFloat(tr.querySelector(".s-uds").value) || 0;
            const price = parseFloat(tr.querySelector(".s-price").value.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
            const lineTot = uds * price;
            tr.querySelector(".s-tot").value = lineTot.toFixed(2) + " ‚Ç¨";
            total += lineTot;
        });
        document.getElementById("totalAmount").innerText = total.toFixed(2);
    }

    function updatePresupuestoDates() {
        const dates = [];
        document.querySelectorAll(".s-date").forEach(i => { if(i.value) dates.push(i.value); });
        if(dates.length > 0) {
            dates.sort();
            document.getElementById("inpFechaDesde").value = dates[0];
            document.getElementById("inpFechaHasta").value = dates[dates.length-1];
        }
    }

    /* ---------------------------------------------------------------
       3. GUARDAR FICHA (BLINDADA CONTRA ERROR DE COLECCI√ìN)
       --------------------------------------------------------------- */
    async function guardarFicha() {
        const id = document.getElementById("dataId").value;
        let type = document.getElementById("dataType").value;
        
        // 1. BLINDAJE: Si ya existe, recuperar tipo REAL de la cach√©
        if (id && dataCache.length > 0) {
            const itemReal = dataCache.find(x => x.id === id);
            if (itemReal) {
                // Si estamos en m√≥dulo presupuestos, forzamos correcci√≥n
                if (currentModule === "presupuestos") type = "presupuesto";
                else type = itemReal.type; 
            }
        }

        if (!type || !id) {
            if (currentModule === "presupuestos") type = "presupuesto";
            else if (currentModule === "restaurante") type = "restaurante";
            else if (currentModule === "grandes_eventos") type = "gran_evento";
            else type = "evento"; 
        }

        document.getElementById("dataType").value = type;

        const data = {
            type: type,
            hotel: currentHotel,
            nombre: document.getElementById("inpNombre")?.value || "",
            salon: document.getElementById("inpSalon")?.value || "",
            estado: document.getElementById("inpEstadoEvento")?.value || "pendiente",
            notas: document.getElementById("inpNotas")?.value || "",
            notaCliente: document.getElementById("inpNotaCliente")?.value || "",
            tel: document.getElementById("inpTel")?.value || "",
            email: document.getElementById("inpEmail")?.value || "",
        };

        if (type === "presupuesto") {
            const desde = document.getElementById("inpFechaDesde")?.value || "";
            const hasta = document.getElementById("inpFechaHasta")?.value || desde;
            data.fechaInicio = desde; 
            data.fechaFin = hasta;
        } else {
            const f1 = document.getElementById("inpFecha")?.value || "";
            const f2 = document.getElementById("inpFecha2")?.value || f1;
            data.fechaInicio = f1; 
            data.fechaFin = f2;
        }
        
        if (type === "restaurante") {
            data.hora = document.getElementById("inpHora")?.value || "";
            data.pax = document.getElementById("inpPaxRest")?.value || "";
            data.precio = document.getElementById("inpPrecioRest")?.value || ""; // Nuevo campo
            data.turno = document.getElementById("inpTurno")?.value || "";
            data.zona = document.getElementById("inpZonaRest")?.value || "";
        } else {
            // ... l√≥gica eventos ...
            data.fechaInicio = document.getElementById("inpFecha").value;
            if(type==="presupuesto") {
                data.fechaInicio = document.getElementById("inpFechaDesde").value;
                data.fechaFin = document.getElementById("inpFechaHasta").value;
            }
            data.salon = document.getElementById("inpSalon").value;
            data.estado = document.getElementById("inpEstadoEvento").value;
            data.turno = document.getElementById("inpTurnoEvento").value;
            data.montaje = document.getElementById("inpMontaje").value;
            data.paxA = document.getElementById("inpPaxA").value;
            data.total = parseFloat(document.getElementById("totalAmount").innerText);
            
            data.lineas = [];
            document.querySelectorAll("#bodyServicios tr").forEach(row => {
               const fecha = row.querySelector(".s-date")?.value || "";
               const concepto = row.querySelector(".s-desc")?.value || "";
               const uds = Number(row.querySelector(".s-uds")?.value || 0);
               const precioVal = row.querySelector(".s-price")?.value || "";
               
               let cleanPrice = String(precioVal).replace(/[^\d,.-]/g, '');
               if(cleanPrice.includes(',') && cleanPrice.includes('.')) cleanPrice = cleanPrice.replace(/\./g, '').replace(',', '.');
               else cleanPrice = cleanPrice.replace(',', '.');
               const precio = parseFloat(cleanPrice) || 0;

               if(concepto) {
                   data.lineas.push({ fecha, concepto, uds, precio, total: uds*precio });
               }
            });
            data.servicios = data.lineas; 

            const totalPres = document.getElementById("totalAmount")?.innerText || "0";
            data.total = parseFloat(totalPres.replace(",", ".").replace(/[^\d.-]/g, '')) || 0;
            data.importeTotal = data.total.toFixed(2) + " ‚Ç¨";

            if (!id && !data.creado) data.creado = new Date().toISOString();
        }

        let collectionName = "eventos"; 
        if (type === "restaurante") collectionName = "restaurante";
        if (type === "presupuesto") collectionName = "presupuestos"; 
        if (type === "gran_evento") collectionName = "grandes_eventos";

        try {
            if (id) { 
                await db.collection(collectionName).doc(id).update(data); 
            } else { 
                await db.collection(collectionName).add(data); 
            }
            alert("‚úî Guardado correctamente");
            document.getElementById("modalFicha").style.display = "none";
        } catch (err) {
            // FIX: Si falla actualizar en 'eventos' (porque era un evento fantasma), intentamos crear en presupuestos
            if(err.message.includes("No document to update") && collectionName === "presupuestos") {
                await db.collection("presupuestos").doc(id).set(data); // .set crea si no existe
                alert("‚úî Recuperado y guardado correctamente en Presupuestos");
                document.getElementById("modalFicha").style.display = "none";
            } else {
                alert("‚ùå Error al guardar: " + err.message); 
                console.error(err);
            }
        }
    }

    async function anularFicha() {
        const id = document.getElementById("dataId").value;
        if (!id) return;
        if (!confirm("¬øDeseas anular este presupuesto? Podr√°s recuperarlo m√°s adelante.")) return;
        try {
            await db.collection("presupuestos").doc(id).update({ estado: "anulado", fechaAnulacion: new Date().toISOString() });
            alert("üü• Presupuesto ANULADO correctamente");
            document.getElementById("modalFicha").style.display = "none";
        } catch (err) { alert("‚ùå Error al anular: " + err.message); console.error(err); }
    }

    async function recuperarFicha() {
        const id = document.getElementById("dataId").value;
        if (!id) return;
        try {
            await db.collection("presupuestos").doc(id).update({ estado: "pendiente", fechaAnulacion: firebase.firestore.FieldValue.delete() });
            alert("üü© Presupuesto recuperado correctamente.");
            document.getElementById("modalFicha").style.display = "none";
        } catch (error) { console.error("Error al recuperar:", error); alert("‚ùå No se pudo recuperar el presupuesto."); }
    }

    async function confirmarPresupuesto() {
        if (!confirm("¬øConfirmar presupuesto? Esto reservar√° los d√≠as en el calendario.")) return;
        document.getElementById("inpEstadoEvento").value = "confirmado";
        const id = document.getElementById("dataId").value;
        await guardarFicha(); 
        
        const numero = document.getElementById("refPresupuesto").value;
        const data = {
            nombre: document.getElementById("inpNombre").value,
            salon: document.getElementById("inpSalon").value,
            fechaInicio: document.getElementById("inpFechaDesde").value,
            fechaFin: document.getElementById("inpFechaHasta").value,
            turno: document.getElementById("inpTurnoEvento").value
        };
        await sincronizarEventosVinculados(numero, data);
        alert("‚úî Presupuesto confirmado y reflejado en el calendario.");
    }

    async function sincronizarEventosVinculados(idRef, data) {
        const snap = await db.collection("master_data").where("refPresupuesto", "==", idRef).get();
        const batch = db.batch();
        snap.forEach(d => batch.delete(d.ref));
        
        const d1 = new Date(data.fechaInicio); 
        const d2 = new Date(data.fechaFin);
        const dias = (d2 - d1) / (1000 * 60 * 60 * 24);
        
        for(let i = 0; i <= dias; i++) {
            const d = new Date(d1); 
            d.setDate(d.getDate() + i);
            const dateStr = d.toISOString().split("T")[0];
            const ref = db.collection("master_data").doc(); 
            
            batch.set(ref, {
                hotel: currentHotel,
                type: 'bloqueo_presupuesto', 
                nombre: data.nombre,
                salon: data.salon,
                fechaInicio: dateStr,
                fechaFin: dateStr,
                estado: 'confirmado',
                refPresupuesto: idRef,
                turno: data.turno
            });
        }
        await batch.commit();
        console.log("Bloqueo de calendario actualizado correctamente.");
    }

    function abrirModalId(id) {
        const d = dataCache.find(x => x.id === id);
        if(!d) return;
        
        const prevMod = currentModule;
        if(d.type==='gran_evento') currentModule='grandes_eventos';
        else if(d.type==='restaurante') currentModule='restaurante';
        else currentModule='presupuestos'; 
        
        nuevo(d.fecha || d.fechaInicio, d.salon || d.zona, d.turno);
        currentModule = prevMod;

        document.getElementById("dataId").value = d.id;
        document.getElementById("dataType").value = d.type;
        
        // TITULO DINAMICO AL EDITAR
        document.getElementById("modalTitle").innerText = d.nombre ? `Reserva: ${d.nombre}` : "Ficha"; 
        
        document.getElementById("inpNombre").value = d.nombre;
        document.getElementById("inpTel").value = d.tel||"";
        document.getElementById("inpEmail").value = d.email||"";
        document.getElementById("inpNotas").value = d.notas||"";

        if(d.type === "restaurante") {
            document.getElementById("inpHora").value = d.hora;
            document.getElementById("inpPaxRest").value = d.pax;
            document.getElementById("inpPrecioRest").value = d.precio || ""; // CAMPO PRECIO
            document.getElementById("inpZonaRest").value = d.zona;
            document.getElementById("inpTurno").value = d.turno;
            
            // Ocultar botones extra
            document.getElementById("btnPdf").style.display = "none";
            document.getElementById("btnConfirmarPpto").style.display = "none";
            document.getElementById("btnEmail").style.display = "none";
            document.getElementById("notasClienteBlock").style.display = "none";
            document.getElementById("grpEmail").style.display = "none"; // Hide email input
            
        } else if(d.type === "gran_evento") {
             document.getElementById("inpAforo").value = d.aforo;
             document.getElementById("inpPrcStd").value = d.precioStd;
             document.getElementById("bodyPart").innerHTML = "";
             if(d.participants) d.participants.forEach(p => addPart(p));
             calcGran();
        } else {
            // Cargar datos evento...
            document.getElementById("inpEstadoEvento").value = d.estado;
            document.getElementById("inpSalon").value = d.salon;
            document.getElementById("inpTurnoEvento").value = d.turno;
            document.getElementById("inpMontaje").value = d.montaje;
            document.getElementById("inpPaxA").value = d.paxA;
            if(d.type === "presupuesto") {
                document.getElementById("refPresupuesto").value = d.numero || "";
                document.getElementById("inpFechaDesde").value = d.fechaInicio;
                document.getElementById("inpFechaHasta").value = d.fechaFin;
            }
            document.getElementById("bodyServicios").innerHTML = "";
            if(d.lineas) d.lineas.forEach(l => addServiceRow({date:l.fecha, desc:l.concepto, uds:l.uds, price:l.precio}));
            calcTotal();
        }
        
        // MOSTRAR BOT√ìN ANULAR (CAMBIADO DE ELIMINAR)
        const btnAnular = document.getElementById("btnAnular");
        btnAnular.style.display = "block";
        btnAnular.innerText = "Anular";
        btnAnular.onclick = anularFicha;
        
        // GESTI√ìN DE BOTONES ESPEC√çFICOS PRESUPUESTO
        if(d.type === "presupuesto") {
            document.getElementById("btnPdf").style.display = "inline-flex";
            document.getElementById("notasClienteBlock").style.display = "block";
            document.getElementById("grpEmail").style.display = "block";
            
            // Si est√° anulado, mostrar RECUPERAR en vez de ANULAR
            if (d.estado === "Anulado" || d.estado === "anulado") {
                btnAnular.style.display = "none";
                document.getElementById("btnRecuperar").style.display = "inline-flex";
            }
        }
    }

    function actualizarTituloModal(val) {
        const id = document.getElementById("dataId").value;
        if(id && val) {
            document.getElementById("modalTitle").innerText = `Reserva: ${val}`;
        }
    }
    
    function cambiarSemana(d) {
        const i = document.getElementById("fechaVista");
        const date = new Date(i.value);
        date.setDate(date.getDate() + d);
        i.valueAsDate = date;
        render();
    }
    
    function safeDate(val) { if(!val) return new Date(); if(val instanceof Date) return val; if(val.includes("-")) { const parts = val.split("-"); return new Date(parts[0], parts[1]-1, parts[2]); } return new Date(val); }
    function formatearFechaListado(s) { if(!s) return "-"; const d=safeDate(s); return d.toLocaleDateString(); }
</script>
</body>
</html>