<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa Chef - Enterprise v3.1</title>
    
    <!-- ESTILOS Y LIBRERÍAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbars personalizadas */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Estilos específicos */
        .nav-item.active { background-color: #0f172a; color: white; }
        .nav-item:hover:not(.active) { background-color: #f1f5f9; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBAK0sGUYpV8KHy1KwIdNRLtHlq5LT3Vwg",
            authDomain: "gestionsalones-bba4b.firebaseapp.com",
            projectId: "gestionsalones-bba4b",
            storageBucket: "gestionsalones-bba4b.firebasestorage.app",
            messagingSenderId: "860164285474",
            appId: "1:860164285474:web:ff995e88093e5aa5eb167b"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. CONSTANTES ---
        const HOTELS = [
            { id: 'Guadiana', name: 'Sercotel Guadiana', color: 'blue', logo: 'Img/logo-guadiana.svg' },
            { id: 'Cumbria', name: 'Cumbria Spa&Hotel', color: 'emerald', logo: 'Img/logo-cumbria.svg' }
        ];
        
        const ESTADOS = ['Pendiente', 'Confirmado', 'Anulado', 'Borrador'];
        const MONTAJES = ['Banquete', 'Escuela', 'Teatro', 'Cóctel', 'Imperial', 'En U'];
        const JORNADAS = ['Jornada Completa', 'Media Jornada (Mañana)', 'Media Jornada (Tarde)', 'Cena / Noche'];

        // --- 3. ICONOS CORREGIDOS (Syntax Fixed) ---
        const Icon = ({ name, className }) => {
            const icons = {
                calendar: <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z"/>,
                users: <><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></>,
                file: <><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></>,
                settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></>,
                check: <polyline points="20 6 9 17 4 12"/>,
                x: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
                plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></>,
                print: <><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>,
                chevronLeft: <polyline points="15 18 9 12 15 6"/>,
                chevronRight: <polyline points="9 18 15 12 9 6"/>,
                search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
                building: <><path d="M6 22V4a2 2 0 012-2h8a2 2 0 012 2v18Z"/><path d="M6 12H4a2 2 0 00-2 2v6a2 2 0 002 2h2"/><path d="M18 9h2a2 2 0 012 2v9a2 2 0 01-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></>,
                wifi: <path d="M5 12.55a11 11 0 0 1 14.08 0"/>,
                wifiOff: <line x1="1" y1="1" x2="23" y2="23"/>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        // --- 4. COMPONENTE APP ---
        const App = () => {
            const [hotel, setHotel] = useState(HOTELS[1]); // Default Cumbria
            const [view, setView] = useState('planning'); 
            const [status, setStatus] = useState('connecting');
            const [data, setData] = useState([]);
            const [config, setConfig] = useState({});
            
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [modalOpen, setModalOpen] = useState(false);
            const [modalType, setModalType] = useState('evento');
            const [formData, setFormData] = useState({});
            const [configOpen, setConfigOpen] = useState(false); // Modal de config rápida

            // INICIO
            useEffect(() => {
                auth.signInAnonymously().catch(err => {
                    console.warn("Auth anónimo falló, intentando acceso directo...", err);
                    setStatus('online'); // Asumimos online si auth falla pero hay red
                });
                
                auth.onAuthStateChanged(user => {
                    if (user) setStatus('online');
                });

                // Comprobación de conexión manual
                window.addEventListener('online', () => setStatus('online'));
                window.addEventListener('offline', () => setStatus('offline'));
            }, []);

            // CARGA DE DATOS
            useEffect(() => {
                if(!hotel) return;
                
                // Config Salones
                const unsubConfig = db.collection("master_data").doc("CONFIG_SALONES").onSnapshot(doc => {
                    if(doc.exists) setConfig(doc.data());
                    else {
                        // Defaults si no existe configuración
                        setConfig({
                            Guadiana: [{name:"Puerta de Alarcos", size:570}, {name:"Puerta de Granada", size:120}],
                            Cumbria: [{name:"Salón Mercurio", size:77}, {name:"Salón La Tierra", size:68}]
                        });
                    }
                });

                // Carga unificada de colecciones
                const loadCollection = (colName, type) => {
                    return db.collection(colName).where("hotel", "==", hotel.id)
                        .onSnapshot(snap => {
                            const items = snap.docs.map(d => ({id: d.id, ...d.data(), type}));
                            setData(prev => [...prev.filter(i => i.type !== type), ...items]);
                        });
                };

                const unsubs = [
                    loadCollection("eventos", "evento"),
                    loadCollection("presupuestos", "presupuesto"),
                    loadCollection("restaurante", "restaurante"),
                    loadCollection("grandes_eventos", "gran_evento")
                ];

                return () => { unsubConfig(); unsubs.forEach(u => u()); };
            }, [hotel]);

            // UTILIDADES
            const getSalones = () => config[hotel.id] || [];
            
            const handleSave = async () => {
                try {
                    let total = 0;
                    if(formData.items) total = formData.items.reduce((acc, i) => acc + (i.qty * i.price), 0);
                    
                    const payload = { ...formData, hotel: hotel.id, total, updatedAt: new Date() };
                    
                    let coll = "eventos";
                    if(modalType === 'presupuesto') coll = "presupuestos";
                    if(modalType === 'restaurante') coll = "restaurante";
                    
                    if(formData.id) await db.collection(coll).doc(formData.id).update(payload);
                    else {
                        payload.createdAt = new Date();
                        payload.estado = payload.estado || 'Pendiente';
                        await db.collection(coll).add(payload);
                    }
                    setModalOpen(false);
                } catch(e) { alert("Error: " + e.message); }
            };

            const handleDelete = async (id, type) => {
                if(!confirm("¿Borrar?")) return;
                let coll = "eventos";
                if(type === 'presupuesto') coll = "presupuestos";
                await db.collection(coll).doc(id).delete();
            };

            // RENDER HEADER (TOP BAR)
            const Header = () => (
                <div className="glass-panel sticky top-0 z-50 px-6 py-3 flex items-center justify-between shadow-sm">
                    {/* IZQUIERDA: Logo y Selector */}
                    <div className="flex items-center gap-6">
                        <div className="flex items-center gap-3">
                            <img 
                                src={hotel.logo} 
                                alt={hotel.name} 
                                className="h-10 object-contain" 
                                onError={(e) => { e.target.style.display='none'; e.target.nextSibling.style.display='flex'; }}
                            />
                            {/* Fallback si no hay imagen */}
                            <div className="hidden h-10 w-10 bg-slate-200 rounded-lg items-center justify-center text-slate-500 font-bold border border-slate-300">
                                {hotel.id.charAt(0)}
                            </div>
                            
                            <div>
                                <h1 className="text-lg font-bold text-slate-800 leading-tight">{hotel.name}</h1>
                                <div className="flex items-center gap-2">
                                    <span className={`w-2 h-2 rounded-full ${status==='online' ? 'bg-emerald-500' : 'bg-red-500'}`}></span>
                                    <span className="text-xs text-slate-500">{status==='online' ? 'Conectado' : 'Offline'}</span>
                                </div>
                            </div>
                        </div>

                        <div className="h-8 w-px bg-slate-200 mx-2"></div>

                        {/* SELECTOR HOTEL */}
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            {HOTELS.map(h => (
                                <button key={h.id} onClick={() => setHotel(h)} 
                                    className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all flex items-center gap-2 ${hotel.id === h.id ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>
                                    {h.id}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* CENTRO: Menú Principal */}
                    <nav className="flex bg-slate-100 p-1 rounded-xl">
                        {[
                            { id: 'planning', label: 'Salones', icon: 'calendar' },
                            { id: 'restaurante', label: 'Restaurante', icon: 'users' },
                            { id: 'presupuestos', label: 'Comercial', icon: 'file' },
                            { id: 'bigevents', label: 'Eventos', icon: 'settings' },
                        ].map(m => (
                            <button key={m.id} onClick={() => setView(m.id)}
                                className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${view === m.id ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500 hover:bg-white hover:text-slate-700'}`}>
                                <Icon name={m.icon} className="w-4 h-4" />
                                {m.label}
                            </button>
                        ))}
                    </nav>

                    {/* DERECHA: Acciones */}
                    <div className="flex items-center gap-3">
                        <button onClick={()=>setConfigOpen(true)} className="p-2 text-slate-400 hover:bg-slate-100 rounded-full transition-colors">
                            <Icon name="settings" className="w-5 h-5"/>
                        </button>
                        <div className="w-9 h-9 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md">
                            A
                        </div>
                    </div>
                </div>
            );

            // RENDER PLANNING
            const PlanningView = () => (
                <div className="p-6 h-full flex flex-col">
                    {/* Toolbar */}
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-4 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                            <button onClick={()=>setDate(d => {const x=new Date(d); x.setDate(x.getDate()-7); return x.toISOString().split('T')[0]})} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500"><Icon name="chevronLeft" className="w-5 h-5"/></button>
                            <input type="date" className="bg-transparent border-none font-bold text-slate-700 text-sm focus:ring-0 outline-none" value={date} onChange={e=>setDate(e.target.value)} />
                            <button onClick={()=>setDate(d => {const x=new Date(d); x.setDate(x.getDate()+7); return x.toISOString().split('T')[0]})} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500"><Icon name="chevronRight" className="w-5 h-5"/></button>
                        </div>
                        <button onClick={()=>{setModalType('evento'); setFormData({fecha:date, items:[]}); setModalOpen(true)}} 
                            className="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-emerald-600/20 flex items-center gap-2 transition-transform active:scale-95">
                            <Icon name="plus" className="w-5 h-5"/> Nuevo Evento
                        </button>
                    </div>

                    {/* Tabla */}
                    <div className="flex-1 bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden flex flex-col">
                        <div className="overflow-auto flex-1">
                            <table className="w-full text-sm border-collapse min-w-[1200px]">
                                <thead className="bg-slate-50 sticky top-0 z-20 shadow-sm">
                                    <tr>
                                        <th className="p-4 text-left w-64 font-bold text-slate-500 text-xs tracking-wider sticky left-0 bg-slate-50 border-b z-30">ESPACIO</th>
                                        {[...Array(7)].map((_, i) => {
                                            const d = new Date(date); d.setDate(d.getDate() + i);
                                            const isToday = new Date().toDateString() === d.toDateString();
                                            return (
                                                <th key={i} className={`p-3 text-center border-b border-l border-slate-200 min-w-[150px] ${isToday ? 'bg-blue-50/50' : ''}`}>
                                                    <span className="block text-[10px] uppercase font-bold text-slate-400">{d.toLocaleDateString('es-ES', {weekday:'short'})}</span>
                                                    <span className={`block text-lg font-bold ${isToday ? 'text-blue-600' : 'text-slate-700'}`}>{d.getDate()}</span>
                                                </th>
                                            );
                                        })}
                                    </tr>
                                </thead>
                                <tbody>
                                    {getSalones().map((s, idx) => (
                                        <tr key={idx} className="group hover:bg-slate-50/50">
                                            <td className="p-4 border-b border-slate-100 bg-white sticky left-0 z-10 border-r group-hover:bg-slate-50/50 transition-colors">
                                                <div className="font-bold text-slate-700">{s.name}</div>
                                                <div className="text-[10px] text-slate-400 mt-0.5 flex items-center gap-2">
                                                    <span>{s.size} m²</span>
                                                    <span className="w-1 h-1 rounded-full bg-slate-300"></span>
                                                    <span>Max {s.pax}</span>
                                                </div>
                                            </td>
                                            {[...Array(7)].map((_, i) => {
                                                const d = new Date(date); d.setDate(d.getDate() + i);
                                                const iso = d.toISOString().split('T')[0];
                                                const evs = data.filter(e => e.type==='evento' && e.salon===s.name && e.fecha===iso && e.estado!=='Anulado');
                                                
                                                return (
                                                    <td key={i} className="border-b border-l border-slate-100 p-1 h-32 align-top relative">
                                                        <div className="h-full w-full flex flex-col gap-1 p-1">
                                                            {evs.map(e => (
                                                                <div key={e.id} onClick={()=>{setFormData(e); setModalType('evento'); setModalOpen(true)}} 
                                                                    className={`p-2.5 rounded-lg border text-xs cursor-pointer shadow-sm hover:shadow-md transition-all ${e.estado==='Confirmado' ? 'bg-emerald-50 border-emerald-200 text-emerald-800' : 'bg-white border-slate-200 text-slate-600'}`}>
                                                                    <div className="font-bold truncate text-sm">{e.nombre}</div>
                                                                    <div className="flex justify-between mt-1 opacity-80 text-[10px]">
                                                                        <span>{e.montaje}</span>
                                                                        <span className="font-bold">{e.pax ? e.pax + ' pax' : ''}</span>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                            {evs.length === 0 && (
                                                                <button onClick={()=>{setFormData({fecha:iso, salon:s.name, items:[]}); setModalType('evento'); setModalOpen(true)}}
                                                                    className="absolute inset-0 w-full h-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <div className="w-8 h-8 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center hover:bg-blue-500 hover:text-white transition-all shadow-sm">
                                                                        <Icon name="plus" className="w-5 h-5"/>
                                                                    </div>
                                                                </button>
                                                            )}
                                                        </div>
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            // RENDER MODAL
            const Modal = () => (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-white">
                            <h3 className="font-bold text-xl text-slate-800 flex items-center gap-3">
                                <div className={`p-2 rounded-lg ${modalType==='presupuesto'?'bg-indigo-100 text-indigo-600':'bg-blue-100 text-blue-600'}`}>
                                    <Icon name={modalType==='presupuesto'?'file':'calendar'} className="w-6 h-6"/>
                                </div>
                                {modalType === 'presupuesto' ? 'Nuevo Presupuesto' : 'Ficha de Evento'}
                            </h3>
                            <button onClick={()=>setModalOpen(false)} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-red-500 transition-colors"><Icon name="x" className="w-6 h-6"/></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-8 bg-slate-50/50">
                            <div className="max-w-4xl mx-auto space-y-8">
                                {/* Datos Generales */}
                                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                                        <div className="md:col-span-3">
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1.5">Fecha</label>
                                            <input type="date" className="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
                                                value={formData.fecha || ''} onChange={e=>setFormData({...formData, fecha:e.target.value})} />
                                        </div>
                                        <div className="md:col-span-6">
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1.5">Cliente / Evento</label>
                                            <input type="text" className="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
                                                value={formData.nombre || ''} onChange={e=>setFormData({...formData, nombre:e.target.value})} placeholder="Ej: Boda García" />
                                        </div>
                                        <div className="md:col-span-3">
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1.5">Estado</label>
                                            <select className="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50"
                                                value={formData.estado || 'Pendiente'} onChange={e=>setFormData({...formData, estado:e.target.value})}>
                                                {ESTADOS.map(s=><option key={s} value={s}>{s}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 pt-4 border-t border-slate-100">
                                        <div className="md:col-span-2">
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1.5">Salón</label>
                                            <select className="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none" value={formData.salon || ''} onChange={e=>setFormData({...formData, salon:e.target.value})}>
                                                <option value="">-- Seleccionar --</option>
                                                {getSalones().map((s,i) => <option key={i} value={s.name}>{s.name} ({s.pax} pax)</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1.5">Montaje</label>
                                            <select className="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none" value={formData.montaje || ''} onChange={e=>setFormData({...formData, montaje:e.target.value})}>
                                                <option value="">--</option>
                                                {MONTAJES.map(m=><option key={m} value={m}>{m}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1.5">Pax</label>
                                            <input type="number" className="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm outline-none" value={formData.pax || ''} onChange={e=>setFormData({...formData, pax:e.target.value})} />
                                        </div>
                                    </div>
                                </div>

                                {/* Desglose */}
                                {(modalType === 'presupuesto' || modalType === 'evento') && (
                                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                        <div className="bg-slate-50 px-6 py-3 border-b border-slate-200 flex justify-between items-center">
                                            <h4 className="font-bold text-xs text-slate-500 uppercase tracking-wider">Servicios y Costes</h4>
                                        </div>
                                        <table className="w-full text-sm">
                                            <thead className="bg-white border-b border-slate-100">
                                                <tr>
                                                    <th className="px-6 py-3 text-left font-semibold text-slate-600">Concepto</th>
                                                    <th className="px-6 py-3 w-24 text-center font-semibold text-slate-600">Uds</th>
                                                    <th className="px-6 py-3 w-32 text-right font-semibold text-slate-600">Precio</th>
                                                    <th className="px-6 py-3 w-32 text-right font-semibold text-slate-600">Total</th>
                                                    <th className="w-10"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {(formData.items || []).map((it, idx) => (
                                                    <tr key={idx} className="border-b border-slate-50 hover:bg-slate-50/50 group">
                                                        <td className="px-6 py-2"><input className="w-full bg-transparent outline-none font-medium text-slate-700" value={it.concept} onChange={e=>{const n=[...formData.items]; n[idx].concept=e.target.value; setFormData({...formData, items:n})}} placeholder="Descripción..."/></td>
                                                        <td className="px-6 py-2"><input type="number" className="w-full text-center bg-transparent outline-none" value={it.qty} onChange={e=>{const n=[...formData.items]; n[idx].qty=Number(e.target.value); setFormData({...formData, items:n})}}/></td>
                                                        <td className="px-6 py-2"><input type="number" className="w-full text-right bg-transparent outline-none" value={it.price} onChange={e=>{const n=[...formData.items]; n[idx].price=Number(e.target.value); setFormData({...formData, items:n})}}/></td>
                                                        <td className="px-6 py-2 text-right font-mono font-bold text-slate-700">{(it.qty*it.price).toFixed(2)}€</td>
                                                        <td className="px-2 text-center text-slate-300 hover:text-red-500 cursor-pointer" onClick={()=>{const n=[...formData.items]; n.splice(idx,1); setFormData({...formData, items:n})}}>&times;</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        <button onClick={()=>setFormData({...formData, items:[...(formData.items||[]), {concept:'', qty:1, price:0}]})} 
                                            className="w-full py-3 bg-slate-50 text-slate-500 font-bold text-xs hover:bg-slate-100 hover:text-blue-600 transition-colors border-t border-slate-100 flex items-center justify-center gap-2">
                                            <Icon name="plus" className="w-4 h-4"/> AÑADIR LÍNEA
                                        </button>
                                    </div>
                                )}

                                {/* Notas */}
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="bg-amber-50 p-4 rounded-xl border border-amber-100">
                                        <label className="block text-xs font-bold text-amber-700 uppercase mb-2">Notas Internas (Cocina/Sala)</label>
                                        <textarea className="w-full bg-white border border-amber-200 rounded-lg p-3 text-sm h-24 outline-none focus:ring-1 focus:ring-amber-400" value={formData.notas || ''} onChange={e=>setFormData({...formData, notas:e.target.value})}></textarea>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Nota Cliente (Visible en PDF)</label>
                                        <textarea className="w-full bg-white border border-slate-300 rounded-lg p-3 text-sm h-24 outline-none focus:ring-1 focus:ring-blue-400" value={formData.notaCliente || ''} onChange={e=>setFormData({...formData, notaCliente:e.target.value})}></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="p-5 border-t border-slate-200 bg-white flex justify-between items-center z-10">
                            {formData.id && (
                                <button onClick={()=>handleDelete(formData.id, modalType)} className="text-red-400 hover:text-red-600 text-sm font-medium flex items-center gap-2 px-4 py-2 hover:bg-red-50 rounded-lg transition-colors">
                                    <Icon name="trash" className="w-4 h-4"/> Eliminar
                                </button>
                            )}
                            <div className="flex gap-3 ml-auto">
                                <button onClick={()=>setModalOpen(false)} className="px-6 py-2.5 text-slate-500 font-bold hover:text-slate-700 transition-colors">Cancelar</button>
                                <button onClick={handleSave} className="bg-slate-900 text-white px-8 py-2.5 rounded-xl font-bold hover:bg-slate-800 shadow-lg shadow-slate-900/20 flex items-center gap-2 transform active:scale-95 transition-all">
                                    <Icon name="check" className="w-5 h-5"/> GUARDAR CAMBIOS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            // RENDER APP STRUCTURE
            return (
                <div className="flex flex-col h-screen overflow-hidden bg-slate-100">
                    <Header />
                    <div className="flex-1 overflow-hidden relative">
                        {view === 'planning' && <PlanningView />}
                        {view === 'presupuestos' && (
                            <div className="p-8 max-w-7xl mx-auto h-full overflow-auto">
                                {/* Lista Presupuestos Estilo Tabla Limpia */}
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                            <tr>
                                                <th className="px-6 py-4">Cliente / Evento</th>
                                                <th className="px-6 py-4">Salón</th>
                                                <th className="px-6 py-4">Fecha</th>
                                                <th className="px-6 py-4 text-right">Total</th>
                                                <th className="px-6 py-4 text-center">Estado</th>
                                                <th className="px-6 py-4"></th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {data.filter(d => d.type === 'presupuesto').map(d => (
                                                <tr key={d.id} className="hover:bg-slate-50 transition-colors group cursor-pointer" onClick={()=>{setFormData(d); setModalType('presupuesto'); setModalOpen(true)}}>
                                                    <td className="px-6 py-4 font-medium text-slate-800">{d.nombre}</td>
                                                    <td className="px-6 py-4 text-slate-500">{d.salon}</td>
                                                    <td className="px-6 py-4 text-slate-500 font-mono text-sm">{d.fecha}</td>
                                                    <td className="px-6 py-4 text-right font-bold text-slate-700">{d.total?.toFixed(2)}€</td>
                                                    <td className="px-6 py-4 text-center">
                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold border ${d.estado==='Confirmado'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-slate-100 text-slate-500 border-slate-200'}`}>
                                                            {d.estado}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 text-right">
                                                        <Icon name="chevronRight" className="w-5 h-5 text-slate-300 group-hover:text-slate-500 transition-colors inline-block"/>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {/* Placeholder para otras vistas */}
                        {(view === 'restaurante' || view === 'bigevents') && (
                            <div className="flex items-center justify-center h-full text-slate-400 flex-col gap-4">
                                <div className="p-6 bg-white rounded-full shadow-sm"><Icon name={view==='restaurante'?'users':'settings'} className="w-10 h-10"/></div>
                                <p>Módulo {view} activo</p>
                            </div>
                        )}
                    </div>
                    {modalOpen && <Modal />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>