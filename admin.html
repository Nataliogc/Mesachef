<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>MesaChef Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Load Tailwind only for inner app -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CRITICAL INLINE STYLES FOR LOGIN */
        body,
        html {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            height: 100%;
        }

        #authOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111827;
            /* Gray-900 */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        .login-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: #059669;
        }

        .hidden {
            display: none !important;
        }

        /* App Styles */
        .tab-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <!-- LOGIN OVERLAY (Self-contained) -->
    <div id="authOverlay">
        <div class="login-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; color:#1f2937;">Acceso Admin</h2>
            <p style="color:#6b7280; margin-bottom: 1.5rem;">Contrase√±a maestra</p>

            <form onsubmit="event.preventDefault(); checkPass();">
                <input type="password" id="passInput"
                    style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; font-size: 16px;"
                    placeholder="Contrase√±a..." autofocus>
                <button type="button" onclick="checkPass()" class="login-btn">Entrar</button>
            </form>
            <p id="errorMsg" style="color: #ef4444; margin-top: 1rem; display: none;">Contrase√±a incorrecta</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appContainer" class="hidden max-w-6xl mx-auto p-4 md:p-8">

        <!-- HEADER -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-lg shadow-sm">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">‚öôÔ∏è MesaChef Enterprise</h1>
                <p class="text-gray-500">Panel de Configuraci√≥n</p>
            </div>
            <div class="mt-4 md:mt-0">
                <a href="index.html" class="text-blue-500 hover:underline mr-4">Inicio</a>
                <button onclick="location.reload()" class="text-red-500 font-medium">Salir</button>
            </div>
        </div>

        <!-- TABS -->
        <div class="bg-white rounded-t-lg shadow-sm border-b px-6 pt-4 flex gap-6 overflow-x-auto">
            <button class="tab-btn active pb-4 px-2" onclick="setTab('Guadiana')">Sercotel Guadiana</button>
            <button class="tab-btn pb-4 px-2" onclick="setTab('Cumbria')">Cumbria Spa&Hotel</button>
            <button class="tab-btn pb-4 px-2" onclick="setTab('Montajes')">Montajes</button>
        </div>

        <!-- CONTENT -->
        <div class="bg-white rounded-b-lg shadow-lg min-h-[400px] p-6">
            <div id="loading" class="text-center py-20 text-gray-400">
                <p class="text-2xl">üì°</p>
                <p>Cargando datos...</p>
            </div>

            <div id="editorArea" class="hidden">
                <div class="flex justify-between items-center mb-6 pb-4 border-b">
                    <h2 class="text-xl font-bold text-gray-700" id="sectionTitle">...</h2>
                    <div id="hotelControls" class="hidden">
                        <button onclick="addSalon()"
                            class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            + A√±adir Sala
                        </button>
                    </div>
                </div>

                <!-- SALONES -->
                <div id="tabSalones" class="hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-xs font-semibold tracking-wide text-gray-500 uppercase border-b bg-gray-50">
                                <th class="px-4 py-3">Nombre</th>
                                <th class="px-4 py-3 w-20">Pax</th>
                                <th class="px-4 py-3 w-24">‚Ç¨ Media</th>
                                <th class="px-4 py-3 w-24">‚Ç¨ Comp.</th>
                                <th class="px-4 py-3 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="tbodySalones"></tbody>
                    </table>
                    <div id="emptyState" class="hidden text-center py-8 text-gray-400">Sin datos</div>
                </div>

                <!-- MONTAJES -->
                <div id="tabMontajes" class="hidden">
                    <div class="flex gap-4 mb-8 bg-gray-50 p-4 rounded-lg items-center">
                        <input id="newMontajeCtx" type="text" class="flex-1 border p-2 rounded"
                            placeholder="Ej: Teatro...">
                        <button onclick="addMontaje()" class="bg-blue-600 text-white px-6 py-2 rounded">A√±adir</button>
                    </div>
                    <div id="listMontajes" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="mt-8 pt-6 border-t flex justify-end">
                    <button onclick="saveConfig()" id="btnSave"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white text-lg px-8 py-3 rounded-lg shadow font-bold">
                        GUARDAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="js/firebase-init.js"></script>

    <script>
        // Check Dependencies
        if (typeof firebase === 'undefined') {
            alert("Error: Firebase no se ha cargado. Revisa tu conexi√≥n.");
        }

        const db = firebase.firestore();
        let currentTab = "Guadiana";
        let fullConfig = { Guadiana: [], Cumbria: [], montajes: [] };

        function checkPass() {
            try {
                const inp = document.getElementById("passInput");
                const err = document.getElementById("errorMsg");
                const val = inp.value.trim().toLowerCase();

                console.log("Checking:", val); // Debug

                if (val === "mesachef2026") {
                    document.getElementById("authOverlay").classList.add("hidden");
                    document.getElementById("appContainer").classList.remove("hidden");
                    loadData();
                } else {
                    err.style.display = "block";
                    err.innerText = "Contrase√±a incorrecta: " + inp.value; // Explicit fail
                    inp.value = "";
                }
            } catch (e) {
                alert("Error script: " + e.message);
            }
        }

        async function loadData() {
            try {
                const doc = await db.collection("master_data").doc("CONFIG_SALONES").get();
                if (doc.exists) {
                    const d = doc.data();
                    fullConfig.Guadiana = d.Guadiana || [];
                    fullConfig.Cumbria = d.Cumbria || [];
                    fullConfig.montajes = d.montajes || [];
                } else {
                    fullConfig.montajes = ["Escuela", "Teatro"];
                }
                document.getElementById("loading").classList.add("hidden");
                document.getElementById("editorArea").classList.remove("hidden");
                render();
            } catch (e) {
                alert("Error cargando configuraci√≥n: " + e.message);
            }
        }

        function setTab(t) {
            currentTab = t;
            document.querySelectorAll(".tab-btn").forEach(b => {
                b.classList.toggle("active", b.innerText.includes(t) || (t === "Montajes" && b.innerText.includes("Montajes")));
            });
            render();
        }

        function render() {
            const ts = document.getElementById("tabSalones");
            const tm = document.getElementById("tabMontajes");
            const hc = document.getElementById("hotelControls");
            const st = document.getElementById("sectionTitle");

            if (currentTab === "Montajes") {
                ts.classList.add("hidden"); tm.classList.remove("hidden"); hc.classList.add("hidden");
                st.innerText = "Tipos de Montaje";
                renderMontajes();
            } else {
                ts.classList.remove("hidden"); tm.classList.add("hidden"); hc.classList.remove("hidden");
                st.innerText = "Salas: " + currentTab;
                renderSalones(currentTab);
            }
        }

        function renderSalones(h) {
            const tb = document.getElementById("tbodySalones");
            tb.innerHTML = "";
            const list = fullConfig[h];
            if (!list.length) { document.getElementById("emptyState").classList.remove("hidden"); return; }
            document.getElementById("emptyState").classList.add("hidden");

            list.forEach((s, i) => {
                tb.innerHTML += `
                    <tr class="border-b">
                        <td class="p-2"><input class="border-none w-full" value="${s.name}" onchange="upd('${h}',${i},'name',this.value)"></td>
                        <td class="p-2"><input type="number" class="border-none w-full text-center" value="${s.pax || 0}" onchange="upd('${h}',${i},'pax',this.value)"></td>
                        <td class="p-2"><input type="number" class="border-none w-full text-right" value="${s.priceHalf || 0}" onchange="upd('${h}',${i},'priceHalf',this.value)"></td>
                        <td class="p-2"><input type="number" class="border-none w-full text-right" value="${s.priceFull || 0}" onchange="upd('${h}',${i},'priceFull',this.value)"></td>
                        <td class="p-2 text-center"><button class="text-red-500 font-bold" onclick="del('${h}',${i})">&times;</button></td>
                    </tr>
                 `;
            });
        }

        function renderMontajes() {
            const list = document.getElementById("listMontajes");
            list.innerHTML = "";
            fullConfig.montajes.forEach((m, i) => {
                list.innerHTML += `<div class="bg-blue-100 px-3 py-1 rounded-full text-blue-800 flex gap-2"><span>${m}</span><button onclick="delM(${i})" class="font-bold text-red-500">&times;</button></div>`;
            });
        }

        window.upd = (h, i, f, v) => { if (f !== 'name') v = parseFloat(v) || 0; fullConfig[h][i][f] = v; };
        window.del = (h, i) => { if (confirm("¬øBorrar?")) { fullConfig[h].splice(i, 1); render(); } };
        window.addSalon = () => { fullConfig[currentTab].push({ name: "Nueva Sala", pax: 0, priceHalf: 0, priceFull: 0 }); render(); };
        window.addMontaje = () => { const v = document.getElementById("newMontajeCtx").value; if (v) { fullConfig.montajes.push(v); render(); } };
        window.delM = (i) => { fullConfig.montajes.splice(i, 1); render(); };

        window.saveConfig = async () => {
            document.getElementById("btnSave").innerText = "Guardando...";
            try {
                await db.collection("master_data").doc("CONFIG_SALONES").set(fullConfig);
                alert("Guardado correctamente");
                document.getElementById("btnSave").innerText = "GUARDAR";
            } catch (e) { alert("Error: " + e.message); }
        };

    </script>
</body>

</html>